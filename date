import React, { useState, useEffect } from "react";
import {
  add,
  sub,
  format,
  parseISO,
  isValid,
  differenceInDays,
  eachDayOfInterval,
  isMonday,
  isTuesday,
  isWednesday,
  isThursday,
  isFriday,
  getUnixTime
} from "date-fns";
import { zhCN } from "date-fns/locale";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectTrigger,
  SelectValue,
  SelectContent,
  SelectItem
} from "@/components/ui/select";

export default function DateTimeCalculator() {
  const [baseDate, setBaseDate] = useState("");
  const [amount, setAmount] = useState(0);
  const [unit, setUnit] = useState("days");
  const [direction, setDirection] = useState("add");
  const [result, setResult] = useState("");
  const [timestampResult, setTimestampResult] = useState("");

  const [dayOfWeekResult, setDayOfWeekResult] = useState("");
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");
  const [dateDiffResult, setDateDiffResult] = useState("");
  const [workdayDiffResult, setWorkdayDiffResult] = useState("");
  const [countdownTarget, setCountdownTarget] = useState("");
  const [countdownResult, setCountdownResult] = useState("");
  const [shareLink, setShareLink] = useState("");

  const handleCalculate = () => {
    const parsedDate = parseISO(baseDate);
    if (!isValid(parsedDate)) {
      setResult("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ï¼Œä¾‹å¦‚ 2025-04-11");
      return;
    }
    const duration = { [unit]: parseInt(amount) };
    const newDate = direction === "add" ? add(parsedDate, duration) : sub(parsedDate, duration);
    setResult(format(newDate, "yyyy-MM-dd HH:mm:ss"));
    setTimestampResult(`Unix æ—¶é—´æˆ³ï¼š${getUnixTime(newDate)}`);
  };

  useEffect(() => {
    const parsed = parseISO(baseDate);
    if (isValid(parsed)) {
      setDayOfWeekResult(format(parsed, "EEEE", { locale: zhCN }));
    } else {
      setDayOfWeekResult("");
    }
  }, [baseDate]);

  const handleDateDiff = () => {
    const start = parseISO(startDate);
    const end = parseISO(endDate);
    if (!isValid(start) || !isValid(end)) {
      setDateDiffResult("è¯·è¾“å…¥æœ‰æ•ˆçš„èµ·å§‹å’Œç»“æŸæ—¥æœŸ");
      return;
    }
    const diff = differenceInDays(end, start);
    setDateDiffResult(`ç›¸å·® ${diff} å¤©`);

    const days = eachDayOfInterval({ start, end });
    const workdays = days.filter(
      (d) => isMonday(d) || isTuesday(d) || isWednesday(d) || isThursday(d) || isFriday(d)
    );
    setWorkdayDiffResult(`å…¶ä¸­å·¥ä½œæ—¥å…± ${workdays.length} å¤©`);
  };

  const handleCountdown = () => {
    const target = parseISO(countdownTarget);
    if (!isValid(target)) {
      setCountdownResult("è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡æ—¥æœŸ");
      return;
    }
    const now = new Date();
    const diff = differenceInDays(target, now);
    setCountdownResult(`è·ç¦»ç›®æ ‡è¿˜æœ‰ ${diff} å¤©`);
    const encoded = encodeURIComponent(target.toISOString());
    setShareLink(`${window.location.origin}/?countdown=${encoded}`);
  };

  return (
    <div className="max-w-xl mx-auto mt-10 p-4 shadow-xl rounded-2xl bg-white space-y-8">
      <div>
        <h1 className="text-2xl font-bold mb-4">ğŸ“… æ—¥æœŸæ—¶é—´è®¡ç®—å™¨</h1>
        <div className="space-y-4">
          <Input type="date" value={baseDate} onChange={(e) => setBaseDate(e.target.value)} placeholder="é€‰æ‹©èµ·å§‹æ—¥æœŸ" />
          <Input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="è¯·è¾“å…¥æ•°é‡" />
          <Select value={unit} onValueChange={setUnit}>
            <SelectTrigger><SelectValue placeholder="é€‰æ‹©å•ä½" /></SelectTrigger>
            <SelectContent>
              <SelectItem value="seconds">ç§’</SelectItem>
              <SelectItem value="minutes">åˆ†é’Ÿ</SelectItem>
              <SelectItem value="hours">å°æ—¶</SelectItem>
              <SelectItem value="days">å¤©</SelectItem>
              <SelectItem value="weeks">å‘¨</SelectItem>
              <SelectItem value="months">æœˆ</SelectItem>
              <SelectItem value="years">å¹´</SelectItem>
            </SelectContent>
          </Select>
          <Select value={direction} onValueChange={setDirection}>
            <SelectTrigger><SelectValue placeholder="é€‰æ‹©æ–¹å‘" /></SelectTrigger>
            <SelectContent>
              <SelectItem value="add">ä¹‹å</SelectItem>
              <SelectItem value="sub">ä¹‹å‰</SelectItem>
            </SelectContent>
          </Select>
          <Button className="w-full" onClick={handleCalculate}>è®¡ç®—</Button>
          {result && <div className="mt-2 text-lg font-semibold">ç»“æœï¼š{result}</div>}
          {timestampResult && <div className="text-sm text-gray-500">{timestampResult}</div>}
        </div>
      </div>

      <div>
        <h2 className="text-xl font-bold mb-2">ğŸ“† æŸ¥è¯¢æ˜ŸæœŸå‡ </h2>
        {dayOfWeekResult && <div className="mt-2">ç»“æœï¼š{dayOfWeekResult}</div>}
      </div>

      <div>
        <h2 className="text-xl font-bold mb-2">ğŸ“Š æ—¥æœŸé—´éš”è®¡ç®—</h2>
        <div className="space-y-2">
          <Input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} placeholder="å¼€å§‹æ—¥æœŸ" />
          <Input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} placeholder="ç»“æŸæ—¥æœŸ" />
          <Button onClick={handleDateDiff}>è®¡ç®—é—´éš”</Button>
          {dateDiffResult && <div className="mt-2">{dateDiffResult}</div>}
          {workdayDiffResult && <div className="mt-1 text-gray-600">{workdayDiffResult}</div>}
        </div>
      </div>

      <div>
        <h2 className="text-xl font-bold mb-2">â³ å€’æ•°è®¡æ—¶å™¨</h2>
        <Input type="date" value={countdownTarget} onChange={(e) => setCountdownTarget(e.target.value)} placeholder="ç›®æ ‡æ—¥æœŸ" />
        <Button onClick={handleCountdown}>å¼€å§‹å€’æ•°</Button>
        {countdownResult && <div className="mt-2">{countdownResult}</div>}
        {shareLink && (
          <div className="mt-2 text-sm text-blue-600 underline">
            <a href={shareLink} target="_blank" rel="noopener noreferrer">åˆ†äº«å€’æ•°é“¾æ¥</a>
          </div>
        )}
      </div>
    </div>
  );
}
